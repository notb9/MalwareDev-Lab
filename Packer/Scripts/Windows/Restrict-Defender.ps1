Write-Output "Disabling Automatic Sample Submission in Windows Defender"

If (-Not (Test-Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender"))
{
    New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft" -Name "Windows Defender"
}

If (-Not (Test-Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet"))
{
    New-Item -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender" -Name "Spynet"
}

Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet" -Name "SpynetReporting" -Value 0
Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender\Spynet" -Name "SubmitSamplesConsent" -Value 2

Write-Output "Disable Cloud-Delivered Protection"
Set-MpPreference -MAPSReporting Disabled
Set-MpPreference -SubmitSamplesConsent NeverSend 

Write-Output "Add defender exclusions to avoid wiping code and tools"
Add-MpPreference -ExclusionPath "C:\Tools" -ErrorAction SilentlyContinue
Add-MpPreference -ExclusionPath "C:\Payloads" -ErrorAction SilentlyContinue
Add-MpPreference -ExclusionPath "C:\ProgramData\Chocolatey" -ErrorAction SilentlyContinue