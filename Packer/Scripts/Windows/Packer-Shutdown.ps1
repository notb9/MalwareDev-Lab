Write-Output "Installing the SetupComplete.cmd script"
$SetupComplete = 'netsh advfirewall firewall set rule name="WinRM-HTTP" new action=allow'

New-Item -Path 'C:\Windows\Setup\Scripts' -ItemType Directory -Force
Set-Content -Path C:\Windows\Setup\Scripts\SetupComplete.cmd -Value $SetupComplete

Write-Output "Blocking inbound WinRM until Setup Finishes after sysprep"
netsh advfirewall firewall set rule name="WinRM-HTTP" new action=block

Write-Output "Starting SysPrep from A:/Unattend.xml"
C:/windows/system32/sysprep/sysprep.exe /generalize /oobe /unattend:A:/Unattend.xml /quiet /shutdown