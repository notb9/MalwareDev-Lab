packer {
  required_plugins {
    virtualbox = {
      source  = "github.com/hashicorp/virtualbox"
      version = "~> 1"
    }
  }
}

variable "cpus" {
  type    = string
  default = "4"
}

variable "memory" {
  type    = string
  default = "4096"
}

variable "disk_size" {
  type    = string
  default = "30000"
}

variable "headless" {
  type    = string
}

variable "iso_checksum" {
  type    = string
}

variable "iso_url" {
  type    = string
}

variable "vm_name" {
  type    = string
}

variable "os_type" {
  type    = string
}

source "virtualbox-iso" "virtualbox" {
  boot_wait                         = "5s"
  boot_command                      = [ "<esc><wait>", "auto", " lowmem/low=true", " ipv6.disable=1", " preseed/url=http://{{.HTTPIP}}:{{.HTTPPort}}/preseed.cfg", "<wait><enter>" ]
  http_directory                    = "${path.cwd}/HTTP"
  communicator                      = "ssh"
  ssh_password                      = "vagrant"
  ssh_username                      = "vagrant"
  ssh_timeout                       = "6h"
  cpus                              = "${var.cpus}"
  disk_size                         = "${var.disk_size}"
  guest_additions_mode              = "disable"
  guest_os_type                     = "${var.os_type}"
  headless                          = "${var.headless}"
  iso_checksum                      = "${var.iso_checksum}"
  iso_url                           = "${var.iso_url}"
  memory                            = "${var.memory}"
  shutdown_command                  = "sudo shutdown now"
  vm_name                           = "${var.vm_name}-base"
  vboxmanage                        = [
    ["modifyvm", "{{.Name}}", "--vram", "128"],
    ["modifyvm", "{{.Name}}", "--nat-localhostreachable1=on"]
  ]
  output_directory                  = "${path.cwd}/Build/output-${var.vm_name}-base/"
}

build {
  sources = [
    "sources.virtualbox-iso.virtualbox"
  ]

}