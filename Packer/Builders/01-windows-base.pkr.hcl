packer {
  required_plugins {
    virtualbox = {
      source  = "github.com/hashicorp/virtualbox"
      version = "~> 1"
    }
  }
}

variable "cpus" {
  type    = string
  default = "4"
}

variable "memory" {
  type    = string
  default = "8192"
}

variable "disk_size" {
  type    = string
  default = "60000"
}

variable "headless" {
  type    = string
}

variable "iso_checksum" {
  type    = string
}

variable "iso_url" {
  type    = string
}

variable "vm_name" {
  type    = string
}

variable "os_type" {
  type    = string
}

source "virtualbox-iso" "virtualbox" {
  boot_wait                         = "2m"
  floppy_files                      = [
                                      "${path.cwd}/AnswerFiles/${title(var.vm_name)}/AutoUnattend.xml",
                                      "${path.cwd}/Scripts/Windows/Enable-WinRM.ps1",
                                      "${path.cwd}/Scripts/Windows/Disable-UAC.ps1"
                                    ]
  communicator                      = "winrm"
  winrm_password                    = "vagrant"
  winrm_username                    = "vagrant"
  winrm_timeout                     = "6h"
  cpus                              = "${var.cpus}"
  disk_size                         = "${var.disk_size}"
  guest_additions_mode              = "attach"
  guest_additions_url               = "ISO/VBoxGuestAdditions.iso"
  guest_os_type                     = "${var.os_type}"
  headless                          = "${var.headless}"
  iso_checksum                      = "${var.iso_checksum}"
  iso_url                           = "${var.iso_url}"
  memory                            = "${var.memory}"
  shutdown_command                  = "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\""
  vm_name                           = "${var.vm_name}-base"
  vboxmanage                        = [
    ["modifyvm", "{{.Name}}", "--vram", "128"],
  ]
  output_directory                  = "${path.cwd}/Build/output-${var.vm_name}-base/"
}

build {
  sources = [
    "sources.virtualbox-iso.virtualbox"
  ]

  provisioner "powershell" {
    scripts = [
      "${path.cwd}/Scripts/Windows/Install-GuestAdditions.ps1"
    ]
    elevated_user = "vagrant"
    elevated_password = "vagrant"
  }
}