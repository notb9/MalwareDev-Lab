packer {
  required_plugins {
    virtualbox = {
      source  = "github.com/hashicorp/virtualbox"
      version = "~> 1"
    }
  }
}

variable "headless" {
  type    = string
}

variable "vm_name" {
  type    = string
}


source "virtualbox-ovf" "virtualbox" {
  source_path                       = "${path.cwd}/Build/output-${var.vm_name}-base/${var.vm_name}-base.ovf"
  boot_wait                         = "5s"
  communicator                      = "ssh"
  ssh_password                      = "vagrant"
  ssh_username                      = "vagrant"
  ssh_timeout                       = "6h"
  guest_additions_mode              = "upload"
  guest_additions_url               = "ISO/VBoxGuestAdditions.iso"
  guest_additions_path              = "/dev/shm/VBoxGuestAdditions.iso"
  shutdown_command                  = "sudo shutdown now"
  headless                          = "${var.headless}"
  vm_name                           = "${var.vm_name}-ga"
  output_directory                  = "${path.cwd}/Build/output-${var.vm_name}-ga/"
}

build {
  sources = [
    "sources.virtualbox-ovf.virtualbox"
  ]

  provisioner "shell" {
    scripts = [
      "${path.cwd}/Scripts/Linux/install-guest-additions.sh"
    ]
    environment_vars = [
      "DEBIAN_FRONTEND=noninteractive"
    ]
  }
}