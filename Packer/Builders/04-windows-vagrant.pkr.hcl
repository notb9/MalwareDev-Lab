packer {
  required_plugins {
    virtualbox = {
      source  = "github.com/hashicorp/virtualbox"
      version = "~> 1"
    }
    vagrant = {
      source  = "github.com/hashicorp/vagrant"
      version = "~> 1"
    }
  }
}

variable "cpus" {
  type    = string
  default = "2"
}

variable "memory" {
  type    = string
  default = "4096"
}

variable "headless" {
  type    = string
}

variable "vm_name" {
  type    = string
}

source "virtualbox-ovf" "virtualbox" { 
  floppy_files                      = [ 
                                      "${path.cwd}/Scripts/Windows/Unattend.xml",
                                      "${path.cwd}/Scripts/Windows/Packer-Shutdown.ps1",
                                    ]
  source_path                       = "${path.cwd}/Build/output-${var.vm_name}-customize/${var.vm_name}-customize.ovf"
  communicator                      = "winrm"
  winrm_password                    = "vagrant"
  winrm_username                    = "vagrant"
  winrm_timeout                     = "6h"
  guest_additions_mode              = "disable"
  shutdown_command                  = "C:/Windows/System32/WindowsPowershell/v1.0/powershell.exe A:/Packer-Shutdown.ps1"
  vm_name                           = "${var.vm_name}-vagrant"
  vboxmanage                        = [
    ["modifyvm", "{{.Name}}", "--vram", "128"],
  ]
  output_directory                  = "${path.cwd}/Build/output-${var.vm_name}-vagrant"
}

build {
  sources = [
    "sources.virtualbox-ovf.virtualbox"
  ]

  post-processor "vagrant" {
    keep_input_artifact = true
    output = "Build/${var.vm_name}.virtualbox.box"
  }
}