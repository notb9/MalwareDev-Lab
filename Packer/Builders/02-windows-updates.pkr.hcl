packer {
  required_plugins {
    virtualbox = {
      source  = "github.com/hashicorp/virtualbox"
      version = "~> 1"
    }
    windows-update = {
      version = "0.15.0"
      source = "github.com/rgl/windows-update"
    }
  }
}

variable "cpus" {
  type    = string
  default = "2"
}

variable "memory" {
  type    = string
  default = "4096"
}

variable "headless" {
  type    = string
}

variable "vm_name" {
  type    = string
}

source "virtualbox-ovf" "virtualbox" {
  source_path                       = "${path.cwd}/Build/output-${var.vm_name}-base/${var.vm_name}-base.ovf"
  communicator                      = "winrm"
  winrm_password                    = "vagrant"
  winrm_username                    = "vagrant"
  winrm_timeout                     = "6h"
  guest_additions_mode              = "disable"
  shutdown_command                  = "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\""
  vm_name                           = "${var.vm_name}-updates"
  vboxmanage                        = [
    ["modifyvm", "{{.Name}}", "--vram", "128"],
  ]
  output_directory                  = "${path.cwd}/Build/output-${var.vm_name}-updates/"
}

build {
  sources = [
    "sources.virtualbox-ovf.virtualbox"
    ]

    provisioner "powershell" {
      scripts = [
        "${path.cwd}/Scripts/Windows/Set-DNS.ps1"
      ]
      elevated_user = "vagrant"
      elevated_password = "vagrant"
    }

    provisioner "windows-update" {
    search_criteria = "IsInstalled=0"
    filters = [
      "exclude:$_.Title -like '*Preview*'",
      "include:$true",
    ]
    update_limit = 25
  }

  provisioner "windows-restart" {
    restart_timeout = "60m"
  }  

  provisioner "windows-update" {
    search_criteria = "IsInstalled=0"
    filters = [
      "exclude:$_.Title -like '*Preview*'",
      "include:$true",
    ]
    update_limit = 25
  }

  provisioner "windows-restart" {
    restart_timeout = "60m"
  }  

  provisioner "windows-update" {
    search_criteria = "IsInstalled=0"
    filters = [
      "exclude:$_.Title -like '*Preview*'",
      "include:$true",
    ]
    update_limit = 25
  }

  provisioner "windows-restart" {
    restart_timeout = "60m"
  }  
}