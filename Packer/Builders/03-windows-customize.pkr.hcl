packer {
  required_plugins {
    virtualbox = {
      source  = "github.com/hashicorp/virtualbox"
      version = "~> 1"
    }
  }
}

variable "cpus" {
  type    = string
  default = "2"
}

variable "memory" {
  type    = string
  default = "4096"
}

variable "headless" {
  type    = string
}

variable "vm_name" {
  type    = string
}

source "virtualbox-ovf" "virtualbox" {
  source_path                       = "${path.cwd}/Build/output-${var.vm_name}-updates/${var.vm_name}-updates.ovf"
  communicator                      = "winrm"
  winrm_password                    = "vagrant"
  winrm_username                    = "vagrant"
  winrm_timeout                     = "6h"
  guest_additions_mode              = "disable"
  shutdown_command                  = "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\""
  vm_name                           = "${var.vm_name}-customize"
  vboxmanage                        = [
    ["modifyvm", "{{.Name}}", "--vram", "128"],
  ]
  output_directory                  = "${path.cwd}/Build/output-${var.vm_name}-customize/"
}

build {
  sources = [
    "sources.virtualbox-ovf.virtualbox"
    ]

    provisioner "powershell" {
        scripts = [
            "${path.cwd}/Scripts/Windows/Set-Customizations.ps1",
            "${path.cwd}/Scripts/Windows/Restrict-Defender.ps1"
        ]
        elevated_user = "vagrant"
        elevated_password = "vagrant"
    }

    provisioner "file" {
      destination = "C:/Users/Vagrant/Desktop/Activate-License.cmd"
      content = "cscript C:\\Windows\\System32\\Slmgr.vbs /rearm"
    }

    provisioner "powershell" {
      scripts = [
        "${path.cwd}/Scripts/Windows/Install-WMF3HotFix.ps1",
        "${path.cwd}/Scripts/Windows/ConfigureRemotingForAnsible.ps1"
      ]
        elevated_user = "vagrant"
        elevated_password = "vagrant"
    }
  

}
