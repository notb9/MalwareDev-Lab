packer {
  required_plugins {
    virtualbox = {
      source  = "github.com/hashicorp/virtualbox"
      version = "~> 1"
    }
  }
}

variable "headless" {
  type    = string
}

variable "vm_name" {
  type    = string
}


source "virtualbox-ovf" "virtualbox" {
  source_path                       = "${path.cwd}/Build/output-${var.vm_name}-ga/${var.vm_name}-ga.ovf"
  boot_wait                         = "5s"
  communicator                      = "ssh"
  ssh_password                      = "vagrant"
  ssh_username                      = "vagrant"
  ssh_timeout                       = "6h"
  guest_additions_mode              = "disable"
  shutdown_command                  = "sudo shutdown now"
  headless                          = "${var.headless}"
  vm_name                           = "${var.vm_name}-vagrant"
  output_directory                  = "${path.cwd}/Build/output-${var.vm_name}-vagrant/"
}

build {
  sources = [
    "sources.virtualbox-ovf.virtualbox"
  ]

  provisioner "shell" {
    scripts = [
      "${path.cwd}/Scripts/Linux/vagrantify.sh"
    ]
  }

  post-processor "vagrant" {
    keep_input_artifact = true
    output = "Build/${var.vm_name}.virtualbox.box"
  }
}