# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.require_version ">= 1.6.2"

Vagrant.configure("2") do |config|
  # https://docs.oracle.com/en/virtualization/virtualbox/6.0/user/vboxmanage-modifyvm.html
  config.vm.boot_timeout = 900
  config.vm.synced_folder '.', '/Vagrant', disabled: true
  config.ssh.keep_alive = true
  config.vm.provider :virtualbox do |v|
    v.customize ["modifyvm", :id, "--vram", 128]
    v.customize ["modifyvm", :id, "--groups", "/MALWARE"]
    v.customize ["modifyvm", :id, "--vrde",  "off"]
    v.customize ["modifyvm", :id, "--clipboard", "bidirectional"]
    v.customize ["modifyvm", :id, "--draganddrop", "bidirectional"]
  end

  config.vm.define "team-server" do |ts|
    ts.vm.define "team-server"
    ts.vm.box = "testing_deb"
    ts.vm.communicator = "ssh"

    ts.vm.synced_folder '../Ansible', '/opt/RedTeam-Lab/Ansible', disabled: false, mount_options: ["dmode=775,fmode=600"]
    
    ts.vm.network :private_network, ip: "10.20.100.200", virtualbox__intnet: "malware"
    ts.vm.network :forwarded_port, guest: 22, host: 22222, host_ip: "127.0.0.1", id: 'ssh', auto_correct: false, disabled: false

    ts.vm.provider :virtualbox do |v|
      v.customize ["modifyvm", :id, "--cpus", 2]
      v.customize ["modifyvm", :id, "--memory", 4096]
      v.customize ["modifyvm", :id, "--graphicscontroller", "vmsvga"]
    end

    ts.vm.provision "shell", path: "setup-teamserver.sh"
  end

  config.vm.define "dev" do |dev|
    dev.vm.define "dev-machine"
    dev.vm.box = "testing_win"
    dev.vm.communicator = "winrm"

    # Admin user name and password
    dev.winrm.username = "vagrant"
    dev.winrm.password = "vagrant"
    dev.winrm.transport = :plaintext
    dev.winrm.basic_auth_only = true

    dev.vm.network :private_network, ip: "10.20.100.100", virtualbox__intnet: "malware"

    dev.vm.guest = :windows
    dev.windows.halt_timeout = 15

    dev.vm.provider :virtualbox do |v|
      v.gui = true
      v.customize ["modifyvm", :id, "--cpus", 4]
      v.customize ["modifyvm", :id, "--memory", 8192]
      v.customize ["modifyvm", :id, "--graphicscontroller", "vboxsvga"]
    end
  end

  config.vm.define "victim" do |vic|
    vic.vm.define "victim-machine"
    vic.vm.box = "testing_win"
    vic.vm.communicator = "winrm"

    # Admin user name and password
    vic.winrm.username = "vagrant"
    vic.winrm.password = "vagrant"
    vic.winrm.transport = :plaintext
    vic.winrm.basic_auth_only = true

    vic.vm.network :private_network, ip: "10.20.100.101", virtualbox__intnet: "malware"

    vic.vm.guest = :windows
    vic.windows.halt_timeout = 15

    vic.vm.provider :virtualbox do |v|
      v.gui = true
      v.customize ["modifyvm", :id, "--cpus", 2]
      v.customize ["modifyvm", :id, "--memory", 4096]
      v.customize ["modifyvm", :id, "--graphicscontroller", "vboxsvga"]
    end
  end

end